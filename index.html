<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Brat Meme Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load html2canvas for screenshot functionality -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.hertzen.min.js"></script>
    <!-- Load a custom font for the Handwritten style -->
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
    <style>
        /* Define the core font styles */
        .font-brat {
            font-family: 'Arial Black', Impact, sans-serif;
            font-weight: 900;
        }
        .font-monospace {
            font-family: 'Courier New', Courier, monospace;
        }
        .font-handwritten {
            font-family: 'Permanent Marker', cursive;
            font-weight: 400; /* Permanent Marker only has one weight */
        }

        /* General text styling applied to the output */
        .brat-text {
            line-height: 1.0; /* Tight line spacing */
            word-break: break-word;
            white-space: pre-wrap; /* Respects line breaks and spaces */
            transition: color 0.1s;
        }
        
        /* Text Outline/Stroke CSS */
        .text-outline-white {
            -webkit-text-stroke: 3px white;
            text-stroke: 3px white;
        }
        .text-outline-black {
            -webkit-text-stroke: 3px black;
            text-stroke: 3px black;
        }

        /* Text shadow for a subtle glow effect on the credit line */
        .text-glow-pink {
            text-shadow: 0 0 3px rgba(255, 0, 100, 0.6), 0 0 6px rgba(255, 0, 150, 0.4);
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a3a3a3;
            border-radius: 4px;
        }
        /* Custom styling for the border-radius slider */
        .range-pink-500::-webkit-slider-thumb {
            background-color: #ec4899; /* pink-500 */
        }
        .range-pink-500::-moz-range-thumb {
            background-color: #ec4899; /* pink-500 */
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center font-inter" style="background-color: #fae6f0;">

    <div class="max-w-xl w-full">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-black tracking-tight leading-tight">
                Brat Text Generator
            </h1>
            <p class="text-sm text-pink-800 mt-1 italic text-glow-pink font-semibold">by Abhiiii...ü´¥üèª for the meme geeks</p>
        </header>

        <div id="meme-canvas" class="w-full aspect-square flex items-center justify-center p-4 shadow-xl mb-6 transition-colors duration-300"
             style="background-color: #fce7f3; min-height: 350px; border-radius: 12px;">
            <div id="brat-output" class="brat-text font-brat text-center text-5xl sm:text-7xl lg:text-8xl w-full leading-none break-words" style="color: #000;">
                Brat and it's the same but there's three more songs so it's not
            </div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-lg space-y-4">
            <div>
                <label for="text-input" class="block text-sm font-medium text-gray-700 mb-1">Your Text (Use Enter for New Lines):</label>
                <textarea id="text-input" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-base"
                          placeholder="Type your meme text here..."></textarea>
            </div>

            <div class="grid grid-cols-2 gap-3 pt-2">
                <button id="style-green-btn" class="w-full py-2 px-4 bg-lime-500 text-black font-semibold rounded-lg shadow-md transition duration-150 text-sm opacity-50 cursor-not-allowed" disabled>
                    Green Scratched Style (Removed)
                </button>
                <button id="style-blue-red-btn" class="w-full py-2 px-4 bg-blue-600 text-red-400 font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 text-sm">
                    Blue/Red Style
                </button>
            </div>
            
            <div class="grid grid-cols-3 gap-3">
                <div class="col-span-3 sm:col-span-1">
                    <label for="text-style" class="block text-sm font-medium text-gray-700 mb-1">Text Style:</label>
                    <select id="text-style" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-sm appearance-none">
                        <option value="font-brat">Brat Style (Impact)</option>
                        <option value="font-monospace">Monospace</option>
                        <option value="font-handwritten">Handwritten</option>
                    </select>
                </div>
                
                <div class="col-span-2 sm:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Text Color:</label>
                    <button id="text-color-btn" class="w-full p-2 bg-black text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-150 text-sm border-2 border-black">
                        Black Text
                    </button>
                </div>

                <div class="col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Case:</label>
                    <button id="case-toggle-btn" class="w-full p-2 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 transition duration-150 text-sm">
                        UPPERCASE
                    </button>
                </div>
            </div>
            
            <div class="w-full">
                <label class="block text-sm font-medium text-gray-700 mb-1">Text Outline (Stroke):</label>
                <button id="outline-toggle-btn" class="w-full p-2 bg-gray-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-150 text-sm border-2 border-gray-400">
                    No Outline
                </button>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Background Color:</label>
                <div id="color-selector" class="flex flex-wrap gap-2 p-2 border border-gray-300 rounded-lg justify-center sm:justify-start"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-transparent mb-1 select-none">Action</label>
                    <button id="randomize-btn" class="w-full py-2 px-4 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 transition duration-150 text-sm">
                        Randomize Placement
                    </button>
                </div>
                
                <div>
                    <label for="font-size" class="block text-sm font-medium text-gray-700 mb-1">Font Size (Max 62px)</label>
                    <input type="range" id="font-size" min="30" max="62" value="62" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-pink-500">
                    <span id="font-size-value" class="text-xs text-gray-500 block text-center mt-1">62px</span>
                </div>
                
                <div>
                    <label for="border-radius" class="block text-sm font-medium text-gray-700 mb-1">Border Radius</label>
                    <input type="range" id="border-radius" min="0" max="50" value="12" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-pink-500">
                    <span id="border-radius-value" class="text-xs text-gray-500 block text-center mt-1">12px</span>
                </div>
            </div>

            <button id="download-btn" class="w-full py-3 px-4 bg-pink-500 text-white text-lg font-bold rounded-lg shadow-xl hover:bg-pink-600 transition duration-150">
                Download Meme (PNG)
            </button>
            
            <div id="limit-message" class="hidden text-center p-4 bg-red-100 border border-red-400 rounded-lg space-y-3">
                <p class="font-bold text-red-700">Opps... You have hit the limit for today ask the secret code from abhi ü§´</p>
                <div class="flex space-x-2">
                    <div class="relative flex-grow">
                        <input type="password" id="secret-password" placeholder="Enter Secret Code" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 text-base">
                        <button id="show-password-btn" class="absolute inset-y-0 right-0 px-3 text-gray-500 hover:text-gray-700 text-sm" type="button">Show</button>
                    </div>
                    <button id="unlock-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-150">Unlock Unlimited</button>
                </div>
                <p id="password-error" class="text-sm text-red-500 hidden">Incorrect code. Try again!</p>
            </div>
        </div>

        <p class="text-center text-xs text-gray-500 mt-4">*Ensure your text and background colors provide enough contrast.</p>
    </div>
    
    <footer class="mt-6 pb-6 text-center text-sm text-gray-600">
        ¬© 2025 Crafted with <span class="text-red-500">üíñ</span> by Abhi for the Meme Geeks
    </footer>

    <script>
        const canvas = document.getElementById('meme-canvas');
        const outputDiv = document.getElementById('brat-output');
        const textInput = document.getElementById('text-input');
        const colorSelector = document.getElementById('color-selector');
        const downloadBtn = document.getElementById('download-btn');
        const randomizeBtn = document.getElementById('randomize-btn');
        const fontSizeInput = document.getElementById('font-size');
        const fontSizeValue = document.getElementById('font-size-value');
        const textStyleSelect = document.getElementById('text-style');
        const textColorBtn = document.getElementById('text-color-btn');
        const caseToggleBtn = document.getElementById('case-toggle-btn');
        const outlineToggleBtn = document.getElementById('outline-toggle-btn');
        const borderRadiusInput = document.getElementById('border-radius');
        const borderRadiusValue = document.getElementById('border-radius-value');
        const limitMessageDiv = document.getElementById('limit-message');
        const secretPasswordInput = document.getElementById('secret-password');
        const unlockBtn = document.getElementById('unlock-btn');
        const passwordError = document.getElementById('password-error');
        const styleGreenBtn = document.getElementById('style-green-btn'); 
        const styleBlueRedBtn = document.getElementById('style-blue-red-btn');
        const showPasswordBtn = document.getElementById('show-password-btn');

        // --- Configuration ---
        const DAILY_LIMIT = 2; 
        const SECRET_CODE = 'ABHIJEET0123';
        const COUNT_KEY = 'bratGenerator_dailyCount';
        const DATE_KEY = 'bratGenerator_lastDate';
        const UNLIMITED_KEY = 'bratGenerator_unlimitedAccess';
        
        let currentOutlineState = 0; 
        const outlineClasses = ['', 'text-outline-white', 'text-outline-black'];
        const outlineLabels = ['No Outline', 'White Outline', 'Black Outline'];

        const colors = [
            { name: 'Light Pink (UI)', value: '#fae6f0', border: 'border-pink-500' },
            { name: 'Pink', value: '#fce7f3', border: 'border-pink-500' }, 
            { name: 'Black', value: '#000000', border: 'border-white' },
            { name: 'White', value: '#ffffff', border: 'border-gray-500' },
            { name: 'Yellow', value: '#fde047', border: 'border-yellow-600' },
            { name: 'Red', value: '#fca5a5', border: 'border-red-600' },
            { name: 'Orange', value: '#fed7aa', border: 'border-orange-600' },
            { name: 'Green', value: '#d9f99d', border: 'border-green-600' },
            { name: 'Dark Green', value: '#065f46', border: 'border-green-800' }
        ];

        // Initial settings
        let currentFontSize = 62;
        let currentFontStyle = 'font-brat';
        let isUppercase = false;
        let isWhiteText = false;
        let activeSpecialStyle = null; 
        let currentBackgroundColor = colors[1].value; 
        let currentTextColor = colors[2].value; // Black
        let currentActiveColorButton = null;

        function showMessageBox(message) {
            let msgDiv = document.getElementById('temp-message-box');
            if (!msgDiv) {
                msgDiv = document.createElement('div');
                msgDiv.id = 'temp-message-box';
                msgDiv.className = 'fixed top-4 right-4 bg-pink-600 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300 opacity-0 transform translate-x-1/2';
                document.body.appendChild(msgDiv);
            }
            msgDiv.textContent = message;
            msgDiv.classList.remove('opacity-0', 'translate-x-1/2');
            msgDiv.classList.add('opacity-100', 'translate-x-0');
            setTimeout(() => {
                msgDiv.classList.remove('opacity-100', 'translate-x-0');
                msgDiv.classList.add('opacity-0', 'translate-x-1/2');
                setTimeout(() => msgDiv.remove(), 300);
            }, 3000);
        }

        function applyScreenProtection() {
            canvas.oncontextmenu = (e) => {
                e.preventDefault();
                showMessageBox("Screenshot features are restricted until unlocked!");
            };
            window.onkeydown = (e) => {
                if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 'P')) {
                    e.preventDefault();
                    showMessageBox("Printing is disabled due to the daily limit. Please unlock!");
                    return false;
                }
            };
        }

        function removeScreenProtection() {
            canvas.oncontextmenu = null;
            window.onkeydown = null;
        }

        function checkDailyLimit() {
            if (localStorage.getItem(UNLIMITED_KEY) === 'true') {
                return { allowed: true, count: 'Unlimited' };
            }
            const today = new Date().toDateString();
            const lastDate = localStorage.getItem(DATE_KEY);
            let count = parseInt(localStorage.getItem(COUNT_KEY) || '0', 10);
            if (lastDate !== today) {
                count = 0;
                localStorage.setItem(COUNT_KEY, '0');
                localStorage.setItem(DATE_KEY, today);
            }
            const allowed = count < DAILY_LIMIT;
            return { allowed: allowed, count: count };
        }

        function incrementCount() {
            if (localStorage.getItem(UNLIMITED_KEY) === 'true') {
                return;
            }
            let count = parseInt(localStorage.getItem(COUNT_KEY) || '0', 10);
            count += 1;
            localStorage.setItem(COUNT_KEY, count.toString());
            if (count >= DAILY_LIMIT) updateDownloadButtonState();
        }

        function showLimitMessage() {
            downloadBtn.classList.add('hidden');
            limitMessageDiv.classList.remove('hidden');
        }

        function hideLimitMessage() {
            downloadBtn.classList.remove('hidden');
            limitMessageDiv.classList.add('hidden');
        }
        
        function updateDownloadButtonState() {
            const status = checkDailyLimit();
            if (status.allowed) {
                hideLimitMessage();
                removeScreenProtection();
                if (status.count === 'Unlimited') {
                    downloadBtn.textContent = 'Download Meme (Unlimited)';
                } else {
                    downloadBtn.textContent = `Download Meme (PNG) (${status.count}/${DAILY_LIMIT} Used)`;
                }
                downloadBtn.disabled = false;
            } else {
                downloadBtn.textContent = 'Download Meme (Limit Reached)';
                downloadBtn.disabled = true;
                showLimitMessage();
                applyScreenProtection();
            }
        }

        function handleUnlock() {
            const code = secretPasswordInput.value.trim();
            if (code === SECRET_CODE) {
                localStorage.setItem(UNLIMITED_KEY, 'true');
                passwordError.classList.add('hidden');
                limitMessageDiv.innerHTML = '<p class="font-bold text-green-700">Success! You now have UNLIMITED generations! Enjoy! üéâ</p>';
                removeScreenProtection();
                updateDownloadButtonState();
                downloadBtn.disabled = false;
                downloadBtn.classList.remove('hidden');
            } else {
                passwordError.classList.remove('hidden');
                secretPasswordInput.value = '';
                showMessageBox("Incorrect code!");
            }
        }
        
        function toggleShowPassword() {
            if (secretPasswordInput.type === 'password') {
                secretPasswordInput.type = 'text';
                showPasswordBtn.textContent = 'Hide';
            } else {
                secretPasswordInput.type = 'password';
                showPasswordBtn.textContent = 'Show';
            }
        }

        function updateText() {
            let text = textInput.value.trim();
            if (text === "") {
                 text = "Brat and it's the same but there's three more songs so it's not";
            }
            outputDiv.textContent = text;
            resetPlacement(); 
            applyActiveStyle(); 
        }

        function applyColor(colorValue) {
            currentBackgroundColor = colorValue;
            canvas.style.backgroundColor = colorValue;
        }

        function applyTextColor(colorValue) {
             currentTextColor = colorValue;
             outputDiv.style.color = colorValue;
        }

        function applyFontStyle(styleClass) {
            outputDiv.classList.remove(currentFontStyle);
            outputDiv.classList.add(styleClass);
            currentFontStyle = styleClass;
            applyFontSize(currentFontSize); 
        }

        function toggleTextColor() {
            activeSpecialStyle = null; 
            deactivateStyleButtons();
            isWhiteText = !isWhiteText;
            const color = isWhiteText ? '#ffffff' : '#000000';
            const textLabel = isWhiteText ? 'White Text' : 'Black Text';
            applyTextColor(color);
            textColorBtn.textContent = textLabel;
            textColorBtn.classList.toggle('bg-black', !isWhiteText);
            textColorBtn.classList.toggle('text-white', !isWhiteText);
            textColorBtn.classList.toggle('bg-white', isWhiteText);
            textColorBtn.classList.toggle('text-black', isWhiteText);
        }
        
        function toggleOutline() {
            currentOutlineState = (currentOutlineState + 1) % outlineClasses.length;
            outputDiv.classList.remove(...outlineClasses.filter(c => c !== '')); 
            const newClass = outlineClasses[currentOutlineState];
            if (newClass) {
                outputDiv.classList.add(newClass);
                if (currentOutlineState === 1 && currentTextColor === '#ffffff') { 
                    applyTextColor('#000000');
                    isWhiteText = false;
                    textColorBtn.textContent = 'Black Text';
                    textColorBtn.classList.add('bg-black', 'text-white');
                    textColorBtn.classList.remove('bg-white', 'text-black');
                } else if (currentOutlineState === 2 && currentTextColor === '#000000') { 
                    applyTextColor('#ffffff');
                    isWhiteText = true;
                    textColorBtn.textContent = 'White Text';
                    textColorBtn.classList.add('bg-white', 'text-black');
                    textColorBtn.classList.remove('bg-black', 'text-white');
                }
            }
            outlineToggleBtn.textContent = outlineLabels[currentOutlineState];
            outlineToggleBtn.classList.remove('bg-gray-200', 'bg-white', 'bg-black', 'text-gray-800', 'text-white', 'border-gray-400', 'border-black', 'border-white');
            if (currentOutlineState === 0) {
                outlineToggleBtn.classList.add('bg-gray-200', 'text-gray-800', 'border-gray-400');
            } else if (currentOutlineState === 1) { 
                 outlineToggleBtn.classList.add('bg-white', 'text-black', 'border-black');
            } else { 
                 outlineToggleBtn.classList.add('bg-black', 'text-white', 'border-white');
            }
        }

        function toggleCase() {
            isUppercase = !isUppercase;
            if (isUppercase) {
                outputDiv.classList.add('uppercase');
                caseToggleBtn.textContent = 'Normal Case';
                caseToggleBtn.classList.replace('bg-purple-500', 'bg-red-500');
                caseToggleBtn.classList.replace('hover:bg-purple-600', 'hover:bg-red-600');
            } else {
                outputDiv.classList.remove('uppercase');
                caseToggleBtn.textContent = 'UPPERCASE';
                caseToggleBtn.classList.replace('bg-red-500', 'bg-purple-500');
                caseToggleBtn.classList.replace('hover:bg-red-600', 'hover:bg-purple-600');
            }
        }

        function applyFontSize(size) {
            currentFontSize = Math.min(size, 62);
            fontSizeInput.value = currentFontSize; 
            outputDiv.style.fontSize = `${currentFontSize}px`;
            fontSizeValue.textContent = `${currentFontSize}px`;
            outputDiv.style.lineHeight = (currentFontStyle === 'font-handwritten') ? '1.1' : '1.0';
        }

        function applyBorderRadius(radius) {
            canvas.style.borderRadius = `${radius}px`;
            borderRadiusValue.textContent = `${radius}px`;
        }

        function createColorButtons() {
            colorSelector.innerHTML = '';
            colors.forEach((color, index) => {
                const button = document.createElement('button');
                button.className = `w-8 h-8 rounded-full shadow-md transition duration-150 transform hover:scale-110 ${color.border} border-2`;
                button.style.backgroundColor = color.value;
                button.title = color.name;
                button.onclick = () => {
                    activeSpecialStyle = null; 
                    deactivateStyleButtons();
                    applyColor(color.value);
                    applyTextColor(isWhiteText ? '#ffffff' : '#000000');
                    document.querySelectorAll('#color-selector button').forEach(btn => { btn.style.borderWidth = '2px'; });
                    button.style.borderWidth = '4px'; 
                    currentActiveColorButton = button;
                };
                colorSelector.appendChild(button);
                if (index === 1) { 
                    button.style.borderWidth = '4px';
                    currentActiveColorButton = button;
                }
            });
        }
        
        function deactivateStyleButtons() {
            styleBlueRedBtn.classList.remove('ring-4', 'ring-offset-2', 'ring-red-700');
            if (currentActiveColorButton) {
                currentActiveColorButton.style.borderWidth = '2px';
                currentActiveColorButton = null;
            }
        }

        function setSpecialStyle(styleName, styleButton) {
            if (styleName !== 'blue-red') return;
            document.querySelectorAll('#color-selector button').forEach(btn => btn.style.borderWidth = '2px');
            if (activeSpecialStyle === styleName) {
                activeSpecialStyle = null;
                deactivateStyleButtons();
                applyColor(colors[1].value); 
                applyTextColor(colors[2].value); 
                const defaultColorButton = colorSelector.querySelector(`button[title="${colors[1].name}"]`);
                if(defaultColorButton) { defaultColorButton.style.borderWidth = '4px'; currentActiveColorButton = defaultColorButton; }
            } else {
                activeSpecialStyle = styleName;
                deactivateStyleButtons();
                styleButton.classList.add('ring-4', 'ring-offset-2', 'ring-red-700');
                applyColor('#1d4ed8'); 
                applyTextColor('#ef4444'); 
            }
            updateText();
        }
        
        function applyActiveStyle() {
            if (activeSpecialStyle === 'blue-red') {
                applyColor('#1d4ed8');
                applyTextColor('#ef4444');
            } else {
                applyColor(currentBackgroundColor);
                applyTextColor(currentTextColor);
            }
        }

        function randomizePlacement() {
            resetPlacement(); 
            const lines = outputDiv.textContent.split('\n');
            outputDiv.innerHTML = ''; 
            lines.forEach(line => {
                const span = document.createElement('span');
                span.textContent = line.trim();
                const randomMarginLeft = Math.floor(Math.random() * 21) - 10;
                const randomMarginRight = Math.floor(Math.random() * 21) - 10;
                const randomPaddingTop = Math.floor(Math.random() * 11);
                const randomPaddingBottom = Math.floor(Math.random() * 11);
                span.style.display = 'block'; 
                span.style.marginLeft = `${randomMarginLeft}px`;
                span.style.marginRight = `${randomMarginRight}px`;
                span.style.paddingTop = `${randomPaddingTop}px`;
                span.style.paddingBottom = `${randomPaddingBottom}px`;
                span.className = outputDiv.className; 
                span.style.cssText += outputDiv.style.cssText; 
                span.style.color = currentTextColor;
                outputDiv.appendChild(span);
            });
            randomizeBtn.textContent = 'Reset Placement';
            randomizeBtn.classList.replace('bg-orange-500', 'bg-gray-500');
            randomizeBtn.classList.replace('hover:bg-orange-600', 'hover:bg-gray-600');
        }

        function resetPlacement() {
            let text = textInput.value.trim();
            if (text === "") {
                 text = "Brat and it's the same but there's three more songs so it's not";
            }
            outputDiv.textContent = text;
            randomizeBtn.textContent = 'Randomize Placement';
            randomizeBtn.classList.replace('bg-gray-500', 'bg-orange-500');
            randomizeBtn.classList.replace('hover:bg-gray-600', 'hover:bg-orange-600');
            applyFontStyle(currentFontStyle); 
            applyFontSize(currentFontSize);
            if(isUppercase) { outputDiv.classList.add('uppercase'); }
            applyActiveStyle();
        }
        
        // --- Synchronous-open download flow: write HTML into opened window (works on Chrome Android) ---
        function openImageInNewTabFromWindow(winRef, blobOrDataUrl, isBlob, fileName) {
            try {
                if (!winRef || winRef.closed) return false;

                if (isBlob) {
                    const url = URL.createObjectURL(blobOrDataUrl);
                    const html = '<!doctype html><html><head><meta name="viewport" content="width=device-width,initial-scale=1"><title>' + (fileName || 'Brat Meme') + '</title></head><body style="margin:0;display:flex;align-items:center;justify-content:center;background:#fff;"><img src="' + url + '" style="max-width:100%;height:auto;display:block;" alt="Brat Meme" /></body></html>';
                    winRef.document.open();
                    winRef.document.write(html);
                    winRef.document.close();
                    setTimeout(() => URL.revokeObjectURL(url), 8000);
                    return true;
                } else {
                    const html = '<!doctype html><html><head><meta name="viewport" content="width=device-width,initial-scale=1"><title>' + (fileName || 'Brat Meme') + '</title></head><body style="margin:0;display:flex;align-items:center;justify-content:center;background:#fff;"><img src="' + blobOrDataUrl + '" style="max-width:100%;height:auto;display:block;" alt="Brat Meme" /></body></html>';
                    winRef.document.open();
                    winRef.document.write(html);
                    winRef.document.close();
                    return true;
                }
            } catch (e) {
                console.error('openImageInNewTabFromWindow error', e);
                return false;
            }
        }

        function handleDownload() {
            const status = checkDailyLimit();
            if (!status.allowed) {
                updateDownloadButtonState();
                showMessageBox("Limit reached! Enter the code to download.");
                return;
            }

            // Open a blank window synchronously (avoids popup blocking on mobile Chrome)
            const newWin = window.open('', '_blank');

            const originalBodyBackgroundColor = document.body.style.backgroundColor;
            document.body.style.backgroundColor = canvas.style.backgroundColor || currentBackgroundColor;

            html2canvas(canvas, { allowTaint: true, useCORS: true, scale: 2 })
                .then(canvasImage => {
                    let blobHandled = false;
                    try {
                        canvasImage.toBlob(function(blob) {
                            if (blob && blob.size > 0) {
                                const fileName = 'brat_meme_' + Date.now() + '.png';
                                const opened = openImageInNewTabFromWindow(newWin, blob, true, fileName);
                                if (!opened) {
                                    const url = URL.createObjectURL(blob);
                                    const fallbackWin = window.open(url, '_blank');
                                    setTimeout(() => URL.revokeObjectURL(url), 6000);
                                    if (!fallbackWin) {
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = fileName;
                                        document.body.appendChild(a);
                                        a.click();
                                        document.body.removeChild(a);
                                        URL.revokeObjectURL(url);
                                    }
                                }
                                incrementCount();
                                updateDownloadButtonState();
                                showMessageBox('Image opened in a new tab. Save it from there.');
                                blobHandled = true;
                            } else {
                                console.warn('toBlob returned null/empty blob ‚Äî will fallback to dataURL');
                            }
                        }, 'image/png');
                    } catch (err) {
                        console.warn('toBlob threw an error, will fallback to toDataURL', err);
                    }

                    setTimeout(() => {
                        if (!blobHandled) {
                            try {
                                const dataUrl = canvasImage.toDataURL('image/png');
                                const opened = openImageInNewTabFromWindow(newWin, dataUrl, false, 'brat_meme_' + Date.now() + '.png');
                                if (!opened) {
                                    const fallbackWin = window.open();
                                    if (fallbackWin) {
                                        fallbackWin.document.write('<!doctype html><html><head><title>Brat Meme</title></head><body style="margin:0;display:flex;align-items:center;justify-content:center;background:#fff;"><img src="' + dataUrl + '" style="max-width:100%;height:auto;display:block;" /></body></html>');
                                        fallbackWin.document.close();
                                    } else {
                                        const link = document.createElement('a');
                                        link.href = dataUrl;
                                        link.download = 'brat_meme_' + Date.now() + '.png';
                                        document.body.appendChild(link);
                                        link.click();
                                        document.body.removeChild(link);
                                    }
                                }
                                incrementCount();
                                updateDownloadButtonState();
                                showMessageBox('Image opened in a new tab. Save it from there.');
                            } catch (e) {
                                console.error('Fallback toDataURL failed:', e);
                                showMessageBox('Download failed. Check console for details.');
                            }
                        }
                    }, 700);
                })
                .catch(error => {
                    console.error('html2canvas error:', error);
                    showMessageBox('Image generation failed. Check console for details.');
                    try { if (newWin && !newWin.closed) newWin.close(); } catch(e) {}
                })
                .finally(() => {
                    document.body.style.backgroundColor = originalBodyBackgroundColor;
                });
        }

        // --- Event listeners ---
        textInput.addEventListener('input', updateText);
        textStyleSelect.addEventListener('change', (e) => applyFontStyle(e.target.value));
        textColorBtn.addEventListener('click', toggleTextColor);
        outlineToggleBtn.addEventListener('click', toggleOutline);
        caseToggleBtn.addEventListener('click', toggleCase);
        fontSizeInput.addEventListener('input', (e) => applyFontSize(parseInt(e.target.value)));
        borderRadiusInput.addEventListener('input', (e) => applyBorderRadius(parseInt(e.target.value)));

        styleGreenBtn.addEventListener('click', () => {}); 
        styleBlueRedBtn.addEventListener('click', () => setSpecialStyle('blue-red', styleBlueRedBtn));
        
        showPasswordBtn.addEventListener('click', toggleShowPassword);

        randomizeBtn.addEventListener('click', () => {
            if (randomizeBtn.textContent === 'Randomize Placement') {
                randomizePlacement();
            } else {
                resetPlacement();
            }
        });

        downloadBtn.addEventListener('click', handleDownload);
        unlockBtn.addEventListener('click', handleUnlock);
        secretPasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleUnlock();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            createColorButtons();
            currentFontSize = 62;
            fontSizeInput.value = 62;
            updateText();
            applyFontSize(currentFontSize); 
            applyBorderRadius(parseInt(borderRadiusInput.value));
            updateDownloadButtonState();
        });
    </script>
</body>
</html>
